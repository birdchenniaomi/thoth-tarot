<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.5, user-scalable=yes">
    <title>3D 托特塔羅：元素色彩版</title>
    <style>
        :root {
            --card-w: 80px; --card-h: 130px;
            --gold: #d4af37;
            --bg-major: #8A8A8A;
            --bg-cups: #1075B5;
            --bg-wands: #942712;
            --bg-disks: #AD7E28;
            --bg-swords: #2BCCC4;
        }
        @media (min-width: 768px) { :root { --card-w: 90px; --card-h: 145px; } }
        body {
            background: #020205; color: #e0e0e0; height: 100vh; margin: 0;
            overflow: hidden; font-family: "PingFang TC", sans-serif;
            display: flex; flex-direction: column; align-items: center;
            touch-action: pan-x pan-y pinch-zoom;
        }
        .stars-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            z-index: -1;
        }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.3; animation: twinkle var(--t) infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
        #mainCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            will-change: transform; transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .controls { margin-top: 2vh; text-align: center; z-index: 100; }
        .btn-reset {
            margin-top: 10px; padding: 8px 25px; background: rgba(0,0,0,0.6);
            color: var(--gold); border: 1px solid var(--gold); cursor: pointer;
            border-radius: 30px; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .btn-reset:hover { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }
        .table { position: relative; width: 100vw; height: 250px; perspective: 1200px; display: flex; justify-content: center; align-items: center; margin-top: 10px; }
        .slot-container { display: flex; gap: 30px; margin-top: 20px; z-index: 1; pointer-events: none; }
        .slot { width: var(--card-w); height: var(--card-h); border: 1px dashed rgba(212, 175, 55, 0.3); border-radius: 8px; }
        .card {
            position: absolute; width: var(--card-w); height: var(--card-h);
            cursor: grab; transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.23, 1, 0.32, 1), filter 0.3s;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        .card.flash { filter: brightness(1.8) drop-shadow(0 0 10px #fff); }
        .card-face { position: absolute; width: 100%; height: 100%; border-radius: 8px; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; text-align: center; padding: 12px; box-sizing: border-box; }
        .card-back { background: #0f0f1a; border: 1px solid #333; }
        .card-back::after { content: "✺"; color: var(--gold); opacity: 0.4; font-size: 30px; }
        .card-front {
            color: #111; transform: rotateY(180deg);
            font-weight: bold; font-size: 1rem; border: 4px double var(--gold);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: gold-breathe 3s infinite ease-in-out;
        }
        .card-front.major { background: var(--bg-major); }
        .card-front.cups { background: var(--bg-cups); }
        .card-front.wands { background: var(--bg-wands); }
        .card-front.disks { background: var(--bg-disks); }
        .card-front.swords { background: var(--bg-swords); }
        @keyframes gold-breathe {
            0%, 100% { border-color: var(--gold); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
            50% { border-color: #fff7d1; box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); }
        }
        .dragging { transition: none !important; z-index: 2000 !important; }

        /* 牌義視窗優化 */
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: #e0e0e0;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--gold);
            font-size: 0.8rem;
            line-height: 1.5;
            width: 280px;
            max-width: 90vw;
            box-sizing: border-box;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 3000;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
            word-wrap: break-word;
        }
        #tooltip.visible { opacity: 1; }
        #tooltip h4 { margin: 8px 0 4px; color: var(--gold); font-size: 1rem; }
        #tooltip p { margin: 4px 0; }

        @keyframes shuffle1 { 0%, 100% { transform: translate(0, 0) rotate(0); } 50% { transform: translate(-120px, -10px) rotate(-12deg); } }
        @keyframes shuffle2 { 0%, 100% { transform: translate(0, 0) rotate(0); } 50% { transform: translate(120px, 5px) rotate(15deg); } }
        @keyframes shuffle3 { 0%, 100% { transform: translate(0, 0) rotate(0); } 50% { transform: translate(-70px, 15px) rotate(-8deg); } }
        @keyframes shuffle4 { 0%, 100% { transform: translate(0, 0) rotate(0); } 50% { transform: translate(70px, -15px) rotate(10deg); } }
        .sh-1 { animation: shuffle1 0.4s ease-in-out infinite; }
        .sh-2 { animation: shuffle2 0.4s ease-in-out infinite; }
        .sh-3 { animation: shuffle3 0.4s ease-in-out infinite; }
        .sh-4 { animation: shuffle4 0.4s ease-in-out infinite; }
    </style>
</head>
<body>
    <div class="stars-container" id="stars"></div>
    <div id="mainCanvas">
        <div class="controls">
            <h2 style="margin:0; color:var(--gold); letter-spacing: 2px; text-shadow: 0 0 8px rgba(212,175,55,0.5);">鳥咪托特抽牌 TAROT</h2>
            <p id="hint" style="margin:5px 0; color: #aaa; font-size: 0.9rem;">點擊牌堆展開 (雙指拖動/縮放桌面)</p>
            <button class="btn-reset" onclick="resetGame()">重新洗牌</button>
        </div>
        <div class="table" id="cardTable"></div>
        <div class="slot-container">
            <div class="slot"></div>
            <div class="slot"></div>
            <div class="slot"></div>
        </div>
    </div>
    <div id="tooltip"></div>

    <script>
        const thothCards = ["0 愚者", "I 魔術師", "II 女教皇", "III 皇后", "IV 皇帝", "V 教皇", "VI 戀人", "VII 戰車", "VIII 正義", "IX 隱士", "X 命運之輪", "XI 力量", "XII 倒吊人", "XIII 死亡", "XIV 節制", "XV 惡魔", "XVI 高塔", "XVII 星星", "XVIII 月亮", "XIX 太陽", "XX 永恆", "XXI 宇宙", "權杖騎士", "權杖皇后", "權杖王子", "權杖公主", "權杖1", "權杖2", "權杖3", "權杖4", "權杖5", "權杖6", "權杖7", "權杖8", "權杖9", "權杖10", "聖杯騎士", "聖杯皇后", "聖杯王子", "聖杯公主", "聖杯1", "聖杯2", "聖杯3", "聖杯4", "聖杯5", "聖杯6", "聖杯7", "聖杯8", "聖杯9", "聖杯10", "寶劍騎士", "寶劍皇后", "寶劍王子", "寶劍公主", "寶劍1", "寶劍2", "寶劍3", "寶劍4", "寶劍5", "寶劍6", "寶劍7", "寶劍8", "寶劍9", "寶劍10", "圓盤騎士", "圓盤皇后", "圓盤王子", "圓盤公主", "圓盤1", "圓盤2", "圓盤3", "圓盤4", "圓盤5", "圓盤6", "圓盤7", "圓盤8", "圓盤9", "圓盤10"];

        const cardMeanings = {
            "0 愚者": { general: "純粹潛能、無限可能、冒險開始、純真、無知、無畏、靈性旅程的開端", work: "新機會、創業、轉職、跳脫框架的創意、風險投資", love: "純粹吸引力、不設防的愛、未知戀情、自由不羈的關係", health: "活力充沛、恢復力強，但需注意意外或魯莽傷害", reverse: "魯莽、停滯、害怕未知、錯過機會、愚蠢決定" },
            "I 魔術師": { general: "意志力、創造力、技巧、行動開始、掌握元素、溝通、變幻", work: "創業成功、專案順利、多才多藝、銷售溝通強", love: "魅力四射、主動追求、甜言蜜語、關係快速進展", health: "精力旺盛、恢復快速、手術順利", reverse: "欺騙、技巧不純、計畫受阻、缺乏焦點、操縱" },
            "II 女教皇": { general: "直覺、神秘、潛意識、內在智慧、陰性力量、隱藏知識", work: "研究、學習、靈感、幕後規劃、需要耐心等待", love: "神秘吸引力、靈魂連結、柏拉圖式愛情、內心情感", health: "婦科問題、荷爾蒙平衡、心理健康、夢境訊息", reverse: "秘密曝光、直覺受阻、情緒壓抑、表面假象" },
            "III 皇后": { general: "豐饒、母性、滋養、創造力、自然、美麗、感官享受", work: "創作產業、美容、美食、穩定成長、團隊照顧", love: "浪漫、感性、被寵愛、生育、穩定關係", health: "生育力強、身體豐滿、恢復良好", reverse: "依賴、嫉妒、情緒化、過度溺愛、浪費" },
            "IV 皇帝": { general: "結構、權威、穩定、控制、父性、理性、領導力", work: "管理職、創業、穩定事業、規則制度", love: "穩定關係、保護欲強、傳統婚姻", health: "骨骼強健、體力好，但需注意僵硬", reverse: "專制、頑固、缺乏彈性、權力濫用" },
            "V 教皇": { general: "傳統、精神指導、教育、道德、宗教、尋求建議", work: "教育、顧問、傳統行業、需要證照", love: "傳統戀愛、精神伴侶、長輩介紹", health: "需要專業醫師、傳統療法", reverse: "教條、偏見、錯誤指導、非傳統" },
            "VI 戀人": { general: "選擇、關係、和諧、吸引力、整合對立、愛與美", work: "合作、合夥、重要選擇、平衡工作生活", love: "戀愛、婚姻、靈魂伴侶、重大感情抉擇", health: "荷爾蒙平衡、伴侶支持健康", reverse: "不和、分離、錯誤選擇、誘惑" },
            "VII 戰車": { general: "勝利、意志力、前進、控制情緒、旅程、決心", work: "事業突破、克服障礙、升職、出差", love: "克服感情障礙、積極追求", health: "克服疾病、恢復控制力", reverse: "方向迷失、失敗、衝動、事故" },
            "VIII 正義": { general: "平衡、因果、公平、真相、法律、調整", work: "合約、法律事務、公平評估、裁員或升職", love: "關係平衡、离婚或婚姻、公平對待", health: "平衡恢復、因果疾病", reverse: "不公、訴訟、偏見、失衡" },
            "IX 隱士": { general: "內省、孤獨、指導、智慧、尋求答案、內在光芒", work: "研究、獨立工作、退休、導師", love: "獨身、內心探索、年長伴侶", health: "休養、慢性病、心理治療", reverse: "孤立、拒絕幫助、錯誤指引" },
            "X 命運之輪": { general: "循環、變化、命運、轉折點、機會、輪迴", work: "轉職、運氣轉變、意外機會", love: "緣分、關係變化、輪迴戀情", health: "循環性疾病、運氣恢復", reverse: "惡運、停滯、意外阻礙" },
            "XI 力量": { general: "內在力量、勇氣、耐心、控制慾望、溫柔征服（托特稱Lust）", work: "克服困難、熱情投入、領導力", love: "激情、性吸引力、征服慾望", health: "強健體力、克服病痛", reverse: "軟弱、恐懼、慾望失控" },
            "XII 倒吊人": { general: "犧牲、逆轉視角、放下、啟示、等待、轉變", work: "暫停、轉型期、犧牲短期利益", love: "犧牲、單戀、逆轉關係", health: "懸而未決的病、需要休息", reverse: "頑抗變化、無謂犧牲" },
            "XIII 死亡": { general: "轉變、結束與新生、蛻變、不可避免的改變", work: "結束舊職、新開始、轉型", love: "關係結束、新戀情、分手", health: "手術、重大改變、康復", reverse: "停滯、害怕改變、腐敗" },
            "XIV 節制": { general: "平衡、調和、融合對立、節制、療癒（托特稱Art）", work: "協調、團隊合作、中庸之道", love: "和諧關係、調適彼此", health: "平衡恢復、替代療法", reverse: "極端、衝突、不和" },
            "XV 惡魔": { general: "束縛、慾望、物質依賴、陰影面、誘惑、權力遊戲", work: "金錢糾紛、權力鬥爭、成癮工作", love: "肉體關係、依賴、虐戀", health: "成癮、慢性壓力", reverse: "解放、克服誘惑" },
            "XVI 高塔": { general: "突變、破壞舊結構、啟示、覺醒、災難", work: "突發失業、公司重組、危機", love: "分手、關係崩潰、真相曝光", health: "突發疾病、意外", reverse: "避免災難、緩慢改變" },
            "XVII 星星": { general: "希望、靈感、寧靜、療癒、宇宙指引", work: "靈感爆發、新方向、藝術創作", love: "理想愛情、遠距離、希望重燃", health: "康復、身心療癒", reverse: "失望、缺乏信心" },
            "XVIII 月亮": { general: "幻象、恐懼、直覺、潛意識、欺騙、神秘", work: "不確定、隱藏風險、創意產業", love: "欺騙、不安、幻想愛情", health: "心理問題、婦科、夢魘", reverse: "真相浮現、克服恐懼" },
            "XIX 太陽": { general: "喜悅、成功、活力、清晰、孩子、光明", work: "成功、認可、快樂工作", love: "幸福關係、生子、熱戀", health: "活力充沛、完全康復", reverse: "暫時陰霾、傲慢" },
            "XX 永恆": { general: "審判、重生、覺醒、業力清算、新紀元（托特稱Aeon）", work: "重大轉變、業力回饋、呼召", love: "靈魂重逢、業力關係", health: "重生、重大療癒", reverse: "延遲、無法放下過去" },
            "XXI 宇宙": { general: "完成、圓滿、整合、宇宙合一、旅程結束", work: "目標達成、升職、圓滿結案", love: "靈魂伴侶、婚姻、長久穩定", health: "完全康復、身心合一", reverse: "延遲、未完成、固執" },
            "權杖1": { general: "創造火花、新開始、潛能", work: "新專案、創業靈感", love: "新戀情火花", health: "活力開始", reverse: "延遲、缺乏動力" },
            "權杖2": { general: "規劃、選擇、支配", work: "事業規劃、決策", love: "關係選擇", health: "能量平衡", reverse: "猶豫不決" },
            "權杖3": { general: "建立、展望、商務", work: "事業擴張、遠景", love: "穩定發展", health: "活力穩定", reverse: "延遲實現" },
            "權杖4": { general: "慶祝、完成、和諧", work: "階段完成、團隊和諧", love: "穩定家居", health: "休息恢復", reverse: "不穩定" },
            "權杖5": { general: "競爭、衝突、挑戰", work: "職場競爭、鬥爭", love: "爭吵", health: "壓力", reverse: "競爭結束" },
            "權杖6": { general: "勝利、認可、公眾成功", work: "升職、成功", love: "被追求", health: "克服障礙", reverse: "失敗" },
            "權杖7": { general: "防衛、勇氣、堅持", work: "捍衛立場", love: "保護關係", health: "抵抗疾病", reverse: "退縮" },
            "權杖8": { general: "快速行動、訊息、旅行", work: "突發進展、訊息", love: "快速發展", health: "快速恢復", reverse: "延遲" },
            "權杖9": { general: "堅韌、防備、力量", work: "堅持到底", love: "保護界線", health: "強韌體質", reverse: "疲憊" },
            "權杖10": { general: "負擔、過度努力、壓力", work: "工作過載", love: "壓力關係", health: "精疲力盡", reverse: "釋放負擔" },
            "權杖公主": { general: "熱情、創意、訊息使者", work: "新點子、年輕同事", love: "熱情追求者", health: "活力年輕", reverse: "不成熟" },
            "權杖王子": { general: "冒險、熱情、衝動", work: "積極行動者", love: "熱戀追求", health: "運動型", reverse: "衝動魯莽" },
            "權杖皇后": { general: "自信、熱情、獨立女性", work: "領導女性", love: "性感自信伴侶", health: "活力充沛", reverse: "嫉妒" },
            "權杖騎士": { general: "行動、冒險、熱情領導", work: "創業家、領導者", love: "激情伴侶", health: "強健", reverse: "暴躁" },
            "聖杯1": { general: "情感開始、豐盛、喜悅", work: "創作滿足", love: "新戀情", health: "情感療癒", reverse: "情感阻塞" },
            "聖杯2": { general: "愛、夥伴、和諧", work: "合作", love: "戀愛、婚姻", health: "平衡", reverse: "不和" },
            "聖杯3": { general: "慶祝、友誼、豐盛", work: "團隊慶功", love: "聚會約會", health: "快樂", reverse: "過度享樂" },
            "聖杯4": { general: "倦怠、重新評估、拒絕", work: "工作厭倦", love: "感情冷淡", health: "情緒低落", reverse: "新機會" },
            "聖杯5": { general: "失落、悲傷、遺憾", work: "失敗感", love: "分手", health: "憂鬱", reverse: "希望恢復" },
            "聖杯6": { general: "回憶、童年、懷舊", work: "舊同事", love: "舊情人", health: "童年影響", reverse: "卡在過去" },
            "聖杯7": { general: "幻想、選擇、誘惑", work: "不切實際計劃", love: "幻想愛情", health: "成癮", reverse: "清醒選擇" },
            "聖杯8": { general: "離開、尋求深層、放棄", work: "離職尋找意義", love: "離開關係", health: "靈性療癒", reverse: "無法離開" },
            "聖杯9": { general: "滿足、願望實現、享樂", work: "成功滿足", love: "幸福", health: "身體舒適", reverse: "過度" },
            "聖杯10": { general: "家庭幸福、圓滿、情感豐盛", work: "家庭事業", love: "婚姻家庭", health: "情感支持", reverse: "家庭不和" },
            "聖杯公主": { general: "夢幻、敏感、直覺女性", work: "藝術家", love: "浪漫女孩", health: "敏感體質", reverse: "情緒化" },
            "聖杯王子": { general: "浪漫、藝術、情感追求", work: "創意工作者", love: "浪漫追求者", health: "情感療癒者", reverse: "不實際" },
            "聖杯皇后": { general: "滋養、直覺、母性女性", work: "療癒師", love: "溫柔伴侶", health: "婦女健康", reverse: "情緒淹沒" },
            "聖杯騎士": { general: "浪漫騎士、邀請、情感行動", work: "藝術追求", love: "夢中情人", health: "情感平衡", reverse: "不誠實" },
            "寶劍1": { general: "清晰思維、真相、智力突破", work: "新想法、決策", love: "清晰溝通", health: "頭腦清晰", reverse: "混亂" },
            "寶劍2": { general: "平衡抉擇、僵局、和平", work: "困難決定", love: "冷戰", health: "壓力平衡", reverse: "釋放緊張" },
            "寶劍3": { general: "心碎、痛苦、分離", work: "失望", love: "失戀", health: "心痛", reverse: "療癒" },
            "寶劍4": { general: "休息、恢復、冥想", work: "休假", love: "暫停關係", health: "住院休養", reverse: "行動恢復" },
            "寶劍5": { general: "衝突、失敗、欺騙", work: "職場鬥爭", love: "爭執", health: "壓力戰鬥", reverse: "接受失敗" },
            "寶劍6": { general: "過渡、旅行、療癒之旅", work: "轉職", love: "搬家或旅行", health: "康復之旅", reverse: "卡住" },
            "寶劍7": { general: "策略、偷竊、欺騙", work: "不誠實競爭", love: "背叛", health: "隱疾", reverse: "曝光" },
            "寶劍8": { general: "束縛、受困、自我限制", work: "壓力受困", love: "受害者心態", health: "心理束縛", reverse: "解放" },
            "寶劍9": { general: "焦慮、恐懼、噩夢", work: "壓力崩潰", love: "絕望", health: "失眠憂鬱", reverse: "希望" },
            "寶劍10": { general: "結束、背叛、崩潰", work: "失業", love: "徹底分手", health: "重大危機", reverse: "新生" },
            "寶劍公主": { general: "敏銳、直覺、獨立女性", work: "分析師", love: "理性女孩", health: "敏銳感知", reverse: "冷酷" },
            "寶劍王子": { general: "智力、溝通、年輕思想家", work: "顧問", love: "理性追求", health: "頭腦活躍", reverse: "爭辯" },
            "寶劍皇后": { general: "獨立、清晰、智慧女性", work: "女強人", love: "獨立伴侶", health: "理性健康", reverse: "苦毒" },
            "寶劍騎士": { general: "快速思維、行動、智力追求", work: "快速決策", love: "理性熱情", health: "神經系統", reverse: "衝動" },
            "圓盤1": { general: "物質機會、豐盛開始、健康", work: "新財源", love: "穩定吸引力", health: "身體健康", reverse: "錯失機會" },
            "圓盤2": { general: "平衡變化、適應、多任務", work: "財務平衡", love: "關係起伏", health: "柔軟性", reverse: "失衡" },
            "圓盤3": { general: "團隊合作、技能、建造", work: "合作專案", love: "共同努力", health: "長期健康", reverse: "延遲" },
            "圓盤4": { general: "穩定、安全、擁有、控制", work: "財務穩定", love: "安全感", health: "穩定體質", reverse: "貪婪" },
            "圓盤5": { general: "貧窮、孤立、擔憂", work: "失業", love: "孤獨", health: "貧病", reverse: "恢復" },
            "圓盤6": { general: "慷慨、平衡給予、成功", work: "獎勵、幫助", love: "平衡關係", health: "資源支持", reverse: "不公" },
            "圓盤7": { general: "等待、評估、耐心投資", work: "長期投資", love: "耐心等待", health: "緩慢恢復", reverse: "無收穫" },
            "圓盤8": { general: "技藝、勤奮、學習", work: "學徒、精進技能", love: "穩定努力", health: "規律生活", reverse: "偷工減料" },
            "圓盤9": { general: "豐收、獨享、奢侈", work: "財富累積", love: "獨立滿足", health: "身體舒適", reverse: "過度" },
            "圓盤10": { general: "家族財富、遺產、穩定", work: "家族企業", love: "家族婚姻", health: "世代健康", reverse: "家族糾紛" },
            "圓盤公主": { general: "實踐、孕育、感官女性", work: "實務執行", love: "感官伴侶", health: "孕育力", reverse: "懶散" },
            "圓盤王子": { general: "可靠、勤奮、物質追求", work: "穩健工作者", love: "可靠伴侶", health: "強健體魄", reverse: "固執" },
            "圓盤皇后": { general: "滋養、豐饒、母性大地", work: "穩定女性", love: "溫暖伴侶", health: "豐滿健康", reverse: "依賴" },
            "圓盤騎士": { general: "責任、持久、實務領導", work: "管理實務", love: "長期承諾", health: "持久力", reverse: "停滯" }
        };

        let deck = [...thothCards];
        const table = document.getElementById('cardTable');
        const mainCanvas = document.getElementById('mainCanvas');
        const hint = document.getElementById('hint');
        const tooltip = document.getElementById('tooltip');
        let isSpread = false;
        let selectedCount = 0;
        let hoverTimer = null;

        let isPanning = false, panOffsetX = 0, panOffsetY = 0, startX, startY;

        // 電腦中鍵平移
        window.addEventListener('mousedown', (e) => { if (e.button === 1) { e.preventDefault(); isPanning = true; document.body.style.cursor = 'move'; startX = e.clientX - panOffsetX; startY = e.clientY - panOffsetY; } });
        window.addEventListener('mousemove', (e) => { if (!isPanning) return; panOffsetX = e.clientX - startX; panOffsetY = e.clientY - startY; mainCanvas.style.transform = `translate(${panOffsetX}px, ${panOffsetY}px)`; });
        window.addEventListener('mouseup', (e) => { if (e.button === 1) { isPanning = false; document.body.style.cursor = 'default'; } });

        // 手機單指平移（只在沒點到牌時）
        let touchStartX = 0, touchStartY = 0, touchedElement = null;
        mainCanvas.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                touchedElement = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
                if (touchedElement && touchedElement.classList.contains('card')) return;
                touchStartX = e.touches[0].clientX - panOffsetX;
                touchStartY = e.touches[0].clientY - panOffsetY;
            }
        }, { passive: true });
        mainCanvas.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1 && touchedElement && !touchedElement.classList.contains('card')) {
                e.preventDefault();
                panOffsetX = e.touches[0].clientX - touchStartX;
                panOffsetY = e.touches[0].clientY - touchStartY;
                mainCanvas.style.transform = `translate(${panOffsetX}px, ${panOffsetY}px)`;
            }
        }, { passive: false });

        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.setProperty('--t', (2 + Math.random() * 4) + 's');
                container.appendChild(star);
            }
        }

        function getElementClass(cardName) {
            if (cardName.includes("聖杯")) return "cups";
            if (cardName.includes("權杖")) return "wands";
            if (cardName.includes("寶劍")) return "swords";
            if (cardName.includes("圓盤")) return "disks";
            return "major";
        }

        function showTooltip(card, x, y) {
            const cardName = card.querySelector('.card-front').textContent.trim();
            const meaning = cardMeanings[cardName] || { general: "牌義整理中...", work: "整理中...", love: "整理中...", health: "整理中...", reverse: "整理中..." };
            tooltip.innerHTML = `
                <strong style="color:var(--gold); font-size:1.1rem;">${cardName}</strong>
                <h4>一般含義</h4><p>${meaning.general}</p>
                <h4>工作</h4><p>${meaning.work}</p>
                <h4>感情</h4><p>${meaning.love}</p>
                <h4>健康</h4><p>${meaning.health}</p>
                <h4>逆位含義</h4><p>${meaning.reverse}</p>
            `;
            tooltip.style.left = (x + 15) + 'px';
            tooltip.style.top = (y + 15) + 'px';
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            tooltip.classList.remove('visible');
            if (hoverTimer) clearTimeout(hoverTimer);
        }

        function initCards() {
            table.innerHTML = '';
            deck.sort(() => Math.random() - 0.5);
            for (let i = 0; i < 78; i++) {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.zIndex = i;
                const elementClass = getElementClass(deck[i]);
                card.innerHTML = `<div class="card-face card-back"></div><div class="card-face card-front ${elementClass}">${deck[i]}</div>`;
                card.onclick = (e) => handleCardClick(card, e);

                card.addEventListener('mouseenter', (e) => {
                    if (card.classList.contains('selected') && !('ontouchstart' in window)) {
                        hoverTimer = setTimeout(() => showTooltip(card, e.clientX, e.clientY), 1000);
                    }
                });
                card.addEventListener('mouseleave', hideTooltip);
                card.addEventListener('mousemove', (e) => {
                    if (tooltip.classList.contains('visible')) {
                        tooltip.style.left = (e.clientX + 15) + 'px';
                        tooltip.style.top = (e.clientY + 15) + 'px';
                    }
                });

                card.addEventListener('touchend', (e) => {
                    if (card.classList.contains('selected')) {
                        e.preventDefault();
                        const touch = e.changedTouches[0];
                        if (tooltip.classList.contains('visible')) {
                            hideTooltip();
                        } else {
                            showTooltip(card, touch.clientX, touch.clientY);
                        }
                    }
                });

                table.appendChild(card);
            }
        }

        function handleCardClick(card, e) {
            if ('ontouchstart' in window && card.classList.contains('selected')) return;
            if (!isSpread) {
                const cards = document.querySelectorAll('.card');
                const radius = 350;
                cards.forEach((c, i) => {
                    const angle = ((i / 78) - 0.5) * 110;
                    const x = Math.sin(angle * Math.PI / 180) * radius;
                    const y = (1 - Math.cos(angle * Math.PI / 180)) * radius;
                    c.style.transform = `translateX(${x}px) translateY(${y}px) rotate(${angle}deg)`;
                });
                isSpread = true;
                hint.innerText = "請抽牌，雙指可拖動/縮放桌面";
            } else if (!card.classList.contains('selected')) {
                pickCard(card);
            }
        }

        function pickCard(card) {
            selectedCount++;
            card.classList.add('selected', 'flash');
            setTimeout(() => card.classList.remove('flash'), 300);
            const randomX = (Math.random() - 0.5) * 300;
            const randomY = 180 + Math.random() * 60;
            const randomRot = (Math.random() - 0.5) * 20;
            card.style.zIndex = 1000 + selectedCount;
            card.style.transform = `translate(${randomX}px, ${randomY}px) rotateY(180deg) rotateZ(${randomRot}deg)`;
            makeDraggable(card);
        }

        function resetGame() {
            hideTooltip();
            const cards = document.querySelectorAll('.card');
            isSpread = false; selectedCount = 0;
            panOffsetX = 0; panOffsetY = 0;
            mainCanvas.style.transform = `translate(0,0)`;
            cards.forEach((card, i) => {
                card.style.transform = `translate(0,0) rotate(0deg)`;
                card.style.zIndex = i;
                card.classList.remove('selected');
            });
            setTimeout(() => {
                cards.forEach((card, i) => {
                    const type = (i % 4) + 1;
                    card.classList.add(`sh-${type}`);
                    card.style.zIndex = Math.floor(Math.random() * 80);
                });
            }, 600);
            setTimeout(() => {
                cards.forEach(card => card.classList.remove('sh-1', 'sh-2', 'sh-3', 'sh-4'));
                initCards();
            }, 1800);
        }

        function makeDraggable(el) {
            let p1 = 0, p2 = 0, p3 = 0, p4 = 0;
            el.onmousedown = el.ontouchstart = (e) => {
                if (e.button === 1) return;
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                el.classList.add('dragging');
                p3 = cx; p4 = cy;
                document.onmouseup = document.ontouchend = () => {
                    el.classList.remove('dragging');
                    document.onmouseup = document.onmousemove = document.ontouchend = document.ontouchmove = null;
                };
                document.onmousemove = document.ontouchmove = (ev) => {
                    const ncx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                    const ncy = ev.touches ? ev.touches[0].clientY : ev.clientY;
                    p1 = p3 - ncx; p2 = p4 - ncy; p3 = ncx; p4 = ncy;
                    const matrix = new WebKitCSSMatrix(window.getComputedStyle(el).transform);
                    el.style.transform = `translate(${matrix.m41 - p1}px, ${matrix.m42 - p2}px) rotateY(180deg)`;
                };
            };
        }

        createStars();
        initCards();
    </script>
</body>
</html>
